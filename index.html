<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-store"/>
<title>Sacado Acad√©mie ‚Äî Atelier d‚Äôautomatismes</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{ --brand:#8374a7; }
  body{ margin:0; background:#f8fafc; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .hero{ background:#efe7ff; }
  .card{ background:#fff; border:1px solid #e5e7eb; }
  .btn{ background:var(--brand); color:#fff; }
  .pill{ padding:.45rem .8rem; border:1px solid #e5e7eb; border-radius:999px; background:#fff; cursor:pointer; color:#111827; }
  .pill.active{ background:var(--brand); border-color:var(--brand); color:#fff; }
  .hdr{ background:#f1f5f9; }
  .ok{ background:#dcfce7; } .ko{ background:#fee2e2; }
  .ko-input{ color:#be185d !important; font-weight:700; }

  .diag-bg  { background: rgba(131,116,167,.16) !important; }
  .diag-txt { color:#8374a7 !important; font-weight:700; }
  .fill-hint { background: rgba(131,116,167,.12) !important; }
  .violet-border { border-color:#8374a7 !important; box-shadow:0 0 0 2px rgba(131,116,167,.25) inset; }

  .pair-card{ background: rgba(131,116,167,.10); border:1px solid #8374a7; border-radius:16px; padding:14px 16px; }

  .progress-wrap{ height:10px; background:#e5e7eb; border-radius:9999px; overflow:hidden; }
  .progress-bar{ height:100%; background:#8374a7; transition:width .25s linear; }

  .flash { animation: flash-red 600ms ease-in-out; }
  @keyframes flash-red { 0%{box-shadow:0 0 0 0 rgba(220,38,38,0);} 30%{box-shadow:0 0 0 6px rgba(220,38,38,.45);} 100%{box-shadow:0 0 0 0 rgba(220,38,38,0);} }

  .dark-mode, .dark-mode * { color:#f8fafc !important; }
  .dark-mode .card{ background:#111111 !important; border-color:#334155 !important; }
  .dark-mode .hdr{ background:#1f2937 !important; }
  .dark-mode input, .dark-mode select{ background:#000 !important; color:#f8fafc !important; border-color:#64748b !important; }
  .dark-mode .pill{ background:#fff !important; color:#111827 !important; border-color:#e5e7eb !important; }
  .dark-mode .progress-wrap{ background:#0b0b0b !important; }
  .dark-mode .progress-bar{ background:#a69acc !important; }

  @font-face{
    font-family:'OpenDyslexicLocal';
    src:url('OpenDyslexic-Regular.otf') format('opentype'),
        url('OpenDyslexicAlta-Regular.otf') format('opentype');
    font-display:swap;
  }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="env,react">
const {useState,useEffect,useMemo,useRef} = React;
const BRAND = "#8374a7";
const range=(a,b)=>Array.from({length:b-a+1},(_,i)=>a+i);

/* NAV */
function TopNav({route,go}){
  return(
    <div className="mb-6 rounded-3xl overflow-hidden shadow-sm border card">
      <div className="px-4 py-3 text-white flex items-center justify-between" style={{backgroundColor:BRAND}}>
        <div className="flex items-center gap-3">
          <img src="sacadoLogo.png" className="h-8 w-8 rounded-lg bg-white/90 p-1" alt="SACADO"/>
          <div><div className="font-black leading-tight">Sacado Acad√©mie</div><div className="text-xs opacity-90">Atelier d‚Äôautomatismes</div></div>
        </div>
        <img src="dogbot.png" className="h-8 w-8 rounded-full bg-white/90 p-0.5" alt="DogBot"/>
      </div>
      <div className="px-4 py-3 flex flex-wrap gap-2 bg-white/60">
        {[{k:"/",label:"Accueil"},{k:"/defi",label:"Jeu n¬∞1 ‚Äì D√©fi Tables"},{k:"/pythagore",label:"Jeu n¬∞2 ‚Äì Table de Pythagore"},{k:"/inverse",label:"Jeu n¬∞3 ‚Äì Retrouve la multiplication"}]
         .map(t=><button key={t.k} onClick={()=>go(t.k)} className={"pill "+(route===t.k?"active":"")}>{t.label}</button>)}
      </div>
    </div>
  );
}
function Hero(){
  return(
    <header className="hero p-6 md:p-10 text-center rounded-3xl card">
      <h1 className="text-3xl md:text-5xl font-extrabold text-[var(--brand)]">Sacado Acad√©mie</h1>
      <p className="mt-1 text-xl font-semibold text-[var(--brand)]">Atelier d‚Äôautomatismes</p>
      <p className="mt-2 text-slate-700">Entra√Æne-toi sur les tables de multiplication avec DogBot üêæ</p>
      <img src="dogbot.png" className="mx-auto mt-4 h-28 w-28 rounded-full bg-white p-1 shadow" alt="DogBot"/>
    </header>
  );
}
function Hub(){
  return(
    <main className="max-w-5xl mx-auto px-4 py-8">
      <Hero/>
      <h2 className="text-center text-2xl md:text-3xl font-extrabold text-[var(--brand)] my-6">Choisis ton activit√©</h2>
      <div className="grid md:grid-cols-3 gap-6">
        <article className="card rounded-3xl p-6"><h3 className="text-xl font-extrabold text-[var(--brand)]">Jeu n¬∞1 ‚Äî D√©fi Tables</h3><a href="#/defi" className="inline-block mt-4 px-4 py-2 rounded-2xl btn">Commencer</a></article>
        <article className="card rounded-3xl p-6"><h3 className="text-xl font-extrabold text-[var(--brand)]">Jeu n¬∞2 ‚Äî Table de Pythagore</h3><a href="#/pythagore" className="inline-block mt-4 px-4 py-2 rounded-2xl btn">D√©couvrir</a></article>
        <article className="card rounded-3xl p-6"><h3 className="text-xl font-extrabold text-[var(--brand)]">Jeu n¬∞3 ‚Äî Retrouve la multiplication</h3><a href="#/inverse" className="inline-block mt-4 px-4 py-2 rounded-2xl btn">Jouer</a></article>
      </div>
    </main>
  );
}

/* ACCESS */
function useAccessibility(){
  const [font,setFont]=useState("Arial");
  const [size,setSize]=useState(16);
  const [yellow,setYellow]=useState(false);
  const [black,setBlack]=useState(false);
  const [audio,setAudio]=useState(false);
  useEffect(()=>{ document.body.style.fontSize = `${size}px`; },[size]);

  const rootBg  = black ? "#000000" : (yellow ? "#fff7cc" : "#f8fafc");
  const surface = black ? "#111111" : (yellow ? "#fff2a8" : "#ffffff");
  const rootText= black ? "#f8fafc" : undefined;
  const cardStyle = { backgroundColor: surface, color: rootText };
  const fontFamily =
    font==="Verdana" ? "Verdana, Geneva, Tahoma, sans-serif" :
    font==="OpenDyslexic" ? "OpenDyslexicLocal, Arial, sans-serif" :
    "Arial, Helvetica, sans-serif";

  const speak=(txt)=>{ try{ if(!audio) return; const u=new SpeechSynthesisUtterance(txt); u.lang="fr-FR"; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} };

  return {font,setFont,size,setSize,yellow,setYellow,black,setBlack,audio,setAudio,rootBg,cardStyle,rootText,fontFamily,speak};
}
function AccessibilityCard({acc}){
  return(
    <div className="card rounded-2xl p-4" style={acc.cardStyle}>
      <div className="font-bold mb-2">Accessibilit√©</div>
      <div className="flex gap-2 flex-wrap mb-2">
        <select value={acc.font} onChange={e=>acc.setFont(e.target.value)} className="border rounded p-1">
          <option>Arial</option><option>Verdana</option><option>OpenDyslexic</option>
        </select>
        <select value={acc.size} onChange={e=>acc.setSize(parseInt(e.target.value))} className="border rounded p-1">
          {[16,18,20,22,24].map(s=><option key={s} value={s}>{s}px</option>)}
        </select>
      </div>
      <label className="block"><input type="checkbox" checked={acc.yellow} onChange={e=>acc.setYellow(e.target.checked)}/> Fond jaune</label>
      <label className="block"><input type="checkbox" checked={acc.black} onChange={e=>acc.setBlack(e.target.checked)}/> √âcran noir</label>
      <div className="mt-2 flex items-center gap-2"><input type="checkbox" checked={acc.audio} onChange={e=>acc.setAudio(e.target.checked)}/><label>Audio (TTS)</label></div>
    </div>
  );
}

/* UTIL */
function Progress({remaining,total}){ if(total==null) return null; const pct=Math.max(0,Math.min(100,(remaining/total)*100)); return <div className="progress-wrap mt-2"><div className="progress-bar" style={{width:`${pct}%`}}></div></div>; }
const vibrate=(p=[80,40,120])=>{ try{ if(navigator.vibrate) navigator.vibrate(p);}catch(_){} };

/* R√âCAP avec route explicite */
function Summary({cardStyle,answers,backRoute}){
  const score = answers.filter(a=>a.correct).length;
  return(
    <>
      <div className="rounded-3xl border p-6 shadow-sm card" style={cardStyle}><h2 className="text-2xl font-black">R√©capitulatif</h2><p>Score : {score} / {answers.length} ({Math.round((score/answers.length)*100)}%)</p></div>
      <div className="rounded-3xl border p-4 shadow-sm overflow-x-auto card" style={cardStyle}>
        <table className="w-full text-left text-sm">
          <thead><tr><th>#</th><th>√ânonc√© / R√©sultat</th><th>R√©ponse(s)</th><th>Correction</th><th>Statut</th></tr></thead>
          <tbody>
            {answers.map((r,i)=>(
              <tr key={i} className="border-t">
                <td>{i+1}</td>
                <td>{r.a!=null?`${r.a}√ó${r.b}`:r.product}</td>
                <td>{
                  r.user!=null
                    ? r.user
                    : (r.rows ? r.rows.map(v => (v?.a && v?.b) ? `${v.a}√ó${v.b}` : "‚Äî").join(" ; ") : "‚Äî")
                }</td>
                <td>{r.product ?? (r.expected?r.expected.map(([a,b])=>`${a}√ó${b}`).join(" ; "):"")}</td>
                <td>{r.timeout ? "‚è± Hors d√©lai" : ((r.user==null && !r.rows) ? "‚Äî Pas de r√©ponse" : (r.correct ? "‚úî Juste" : "‚úò Faux"))}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div className="flex gap-2">
        <a className="px-5 py-3 rounded-2xl border" href={`#${backRoute}`}>Retour aux r√©glages</a>
        <a className="px-5 py-3 rounded-2xl border" href="#/">Retour au menu</a>
      </div>
    </>
  );
}

/* =================== JEU 1 =================== (identique) */
function GameDefi({acc}){ /* ‚Ä¶ identique √† ta version pr√©c√©dente ‚Ä¶ */ }

/* =================== JEU 2 =================== (identique √† ta V bonne) */
function GamePythagore({acc}){ /* ‚Ä¶ identique √† ta version pr√©c√©dente ‚Ä¶ */ }

/* =================== JEU 3 =================== */
function GameInverse({acc}){
  const {rootBg,rootText,cardStyle}=acc;
  const [questionCount,setQuestionCount]=useState(10);
  const [timeLimit,setTimeLimit]=useState(15);      // 15s par d√©faut
  const [mode,setMode]=useState("single");          // "single" | "all"
  const [started,setStarted]=useState(false), [finished,setFinished]=useState(false);
  const [questions,setQuestions]=useState([]), [index,setIndex]=useState(0);
  const [tick,setTick]=useState(0), [answers,setAnswers]=useState([]);
  const [flash,setFlash]=useState(false);

  // mode 1
  const [x,setX]=useState(""), [y,setY]=useState("");
  const xRef=useRef(null);

  // mode 2
  const pairsFor=(n)=>{ const out=[]; for(let a=2;a<=10;a++){ const b=n/a; if(Number.isInteger(b)&&b>=2&&b<=10) out.push([a,b]); } return out; };
  const [fields,setFields]=useState([]); // [{a:'',b:''}]
  const firstFieldRef=useRef(null);

  const current=questions[index];

  /* chrono */
  useEffect(()=>{ if(!started||finished) return; const id=setInterval(()=>setTick(t=>t+1),1000); return ()=>clearInterval(id);},[started,finished]);
  useEffect(()=>{ if(!started||finished) return; if(timeLimit!=null && tick>=timeLimit){ setFlash(true); vibrate(); setTimeout(()=>setFlash(false),650); handleSubmit(true);} },[tick]);

  const newProduct=()=>{ const a=2+Math.floor(Math.random()*9), b=2+Math.floor(Math.random()*9); return a*b; };

  const start=()=>{
    const list=Array.from({length:questionCount},()=>({product:newProduct()}));
    setQuestions(list); setIndex(0); setAnswers([]); setTick(0); setStarted(true); setFinished(false);
    const p=list[0].product;
    if(mode==="single"){ setX(""); setY(""); setTimeout(()=>xRef.current?.focus(),0); }
    else { const n=pairsFor(p).length; setFields(Array.from({length:n},()=>({a:"",b:""}))); setTimeout(()=>firstFieldRef.current?.focus(),0); }
  };

  /* r√©init √† chaque question / changement de mode */
  useEffect(()=>{
    if(!started||!current) return;
    if(mode==="single"){ setX(""); setY(""); setTimeout(()=>xRef.current?.focus(),0); }
    else { const n=pairsFor(current.product).length; setFields(Array.from({length:n},()=>({a:"",b:""}))); setTimeout(()=>firstFieldRef.current?.focus(),0); }
  },[index,mode,started,current?.product]);

  const remaining = timeLimit==null ? null : Math.max(0,timeLimit-tick);

  const handleSubmit=(timeout=false)=>{
    if(!current) return;
    if(mode==="single"){
      const a=parseInt(x,10), b=parseInt(y,10);
      const provided=Number.isInteger(a)&&Number.isInteger(b);
      const ok=!timeout&&provided&&a>=2&&a<=10&&b>=2&&b<=10&&(a*b===current.product);
      setAnswers(p=>[...p,{mode,product:current.product,a:provided?a:null,b:provided?b:null,correct:ok,timeout}]);
    }else{
      const target=pairsFor(current.product);
      const want=new Map(); target.forEach(([a,b])=>want.set(`${a}x${b}`,(want.get(`${a}x${b}`)||0)+1));
      const use=new Map(); let exact=true;
      for(const r of fields){
        const a=parseInt(r.a,10), b=parseInt(r.b,10);
        const valid=Number.isInteger(a)&&Number.isInteger(b)&&a>=2&&a<=10&&b>=2&&b<=10&&(a*b===current.product);
        if(!valid){ exact=false; continue; }
        const k=`${a}x${b}`; use.set(k,(use.get(k)||0)+1);
      }
      for(const [k,c] of want){ if(use.get(k)!==c){ exact=false; break; } }
      for(const [k,c] of use){ if(want.get(k)!==c){ exact=false; break; } }
      setAnswers(p=>[...p,{mode,product:current.product,rows:[...fields],correct:!timeout&&exact&&fields.every(r=>r.a&&r.b),timeout,expected:target}]);
    }
    if(index+1>=questions.length){ setFinished(true); setStarted(false); } else { setIndex(i=>i+1); setTick(0); }
  };

  const tip = mode==="single" ? "Tape une seule d√©composition. Ex : 24 ‚Üí 6 et 4 (ou 3 et 8)."
                              : "Tape toutes les d√©compositions (paires ordonn√©es). Ex : 24 ‚Üí 4√ó6, 6√ó4, 3√ó8, 8√ó3.";

  /* inputs contr√¥l√©s (mise √† jour immuable par map) */
  const PairCard=({i})=>{
    const aVal=fields[i]?.a ?? ""; const bVal=fields[i]?.b ?? "";
    return(
      <div className="pair-card flex items-center gap-3 md:gap-4">
        <input
          name={`a-${i}`} ref={i===0?firstFieldRef:null}
          value={aVal}
          onChange={e=>{
            const v=e.target.value.replace(/\D/g,"");
            setFields(prev=>prev.map((row,idx)=> idx===i ? {...row, a:v} : row));
          }}
          inputMode="numeric" type="tel" autoComplete="off" spellCheck="false"
          className="w-20 text-center text-2xl px-3 py-2 rounded-2xl border violet-border fill-hint"/>
        <span className="text-2xl">√ó</span>
        <input
          name={`b-${i}`}
          value={bVal}
          onChange={e=>{
            const v=e.target.value.replace(/\D/g,"");
            setFields(prev=>prev.map((row,idx)=> idx===i ? {...row, b:v} : row));
          }}
          inputMode="numeric" type="tel" autoComplete="off" spellCheck="false"
          className="w-20 text-center text-2xl px-3 py-2 rounded-2xl border violet-border fill-hint"/>
      </div>
    );
  };

  const PairsLayout=()=>{
    const n=current ? pairsFor(current.product).length : 0;
    const top=Math.min(2,n), bottom=n-top;
    return(
      <form onSubmit={(e)=>{e.preventDefault(); handleSubmit(false);}} className="flex flex-col items-center gap-10">
        <div className="flex gap-12 justify-center">
          {Array.from({length:top},(_,i)=><PairCard i={i} key={`top-${i}`}/>)}
        </div>
        {bottom>0 && (
          <div className="flex gap-12 justify-center">
            {Array.from({length:bottom},(_,j)=><PairCard i={top+j} key={`bot-${j}`}/>)}
          </div>
        )}
        <button type="submit" className="mt-2 px-5 py-3 rounded-2xl text-white font-semibold shadow" style={{backgroundColor:BRAND}}>Valider</button>
      </form>
    );
  };

  return(
    <div className={(acc.black?"dark-mode ":"")+"min-h-screen p-6"} style={{backgroundColor:rootBg,color:rootText}}>
      <TopNav route="/inverse" go={k=>location.hash="#"+k}/>
      <div className="max-w-4xl mx-auto space-y-6">
        {!started && !finished && (
          <div className="grid md:grid-cols-3 gap-4">
            <AccessibilityCard acc={acc}/>
            <div className="card rounded-2xl p-4" style={cardStyle}>
              <div className="font-bold mb-2">Mode</div>
              <div className="flex flex-col gap-2">
                <label><input type="radio" name="m3" checked={mode==="single"} onChange={()=>setMode("single")}/> Une d√©composition</label>
                <label><input type="radio" name="m3" checked={mode==="all"} onChange={()=>setMode("all")}/> Toutes les d√©compositions</label>
              </div>
              <div className="font-bold mt-4 mb-1">Nombre de questions</div>
              <div className="flex gap-2 flex-wrap">{[5,10,15,20].map(n=><button key={n} onClick={()=>setQuestionCount(n)} className={"pill "+(questionCount===n?"active":"")}>{n}</button>)}</div>
              <div className="font-bold mt-4 mb-1">Temps par question</div>
              <div className="flex gap-2 flex-wrap">
                {[15,20].map(s=><button key={s} onClick={()=>setTimeLimit(s)} className={"pill "+(timeLimit===s?"active":"")}>{s}s</button>)}
                <button onClick={()=>setTimeLimit(null)} className={"pill "+(timeLimit==null?"active":"")}>Pas de chrono</button>
              </div>
            </div>
            <div className="card rounded-2xl p-4" style={cardStyle}><div className="font-bold mb-2">Action</div><button onClick={start} className="px-4 py-2 rounded-2xl text-white" style={{backgroundColor:BRAND}}>Commencer</button></div>
          </div>
        )}

        {started && current && (
          <div className="space-y-6">
            <div className={"card rounded-2xl p-3 "+(flash?"flash":"")} style={cardStyle}>
              <div className="flex items-center justify-between">
                <div><strong>Question :</strong> {index+1} / {questions.length}</div>
                <div><strong>‚è± Temps :</strong> {timeLimit==null?"Pas de chrono":`${remaining}s`}</div>
              </div>
              <Progress remaining={remaining??0} total={timeLimit}/>
            </div>

            <div className="card rounded-2xl p-3" style={cardStyle}><strong>Consigne :</strong> <span className="diag-txt">{tip}</span></div>

            <div className="rounded-3xl border p-6 text-center shadow-sm card" style={cardStyle}>
              <div className="text-slate-500">R√©sultat</div>
              <div className="font-black text-5xl mb-6">{current.product}</div>

              {mode==="single" ? (
                <form onSubmit={(e)=>{e.preventDefault(); handleSubmit(false);}} className="flex gap-4 justify-center items-center">
                  <input ref={xRef} value={x} onChange={e=>setX(e.target.value.replace(/\D/g,""))} inputMode="numeric" type="tel" autoComplete="off" spellCheck="false" className="w-24 text-center text-3xl px-4 py-3 rounded-2xl border violet-border fill-hint"/>
                  <span className="text-3xl">√ó</span>
                  <input value={y} onChange={e=>setY(e.target.value.replace(/\D/g,""))} inputMode="numeric" type="tel" autoComplete="off" spellCheck="false" className="w-24 text-center text-3xl px-4 py-3 rounded-2xl border violet-border fill-hint"/>
                  <button type="submit" className="px-5 py-3 rounded-2xl text-white font-semibold shadow" style={{backgroundColor:BRAND}}>Valider</button>
                </form>
              ) : (
                <PairsLayout/>
              )}
            </div>
          </div>
        )}

        {finished && <Summary cardStyle={cardStyle} answers={answers} backRoute="/inverse"/>}
      </div>
    </div>
  );
}

/* APP */
function App(){
  const [route,setRoute]=useState(location.hash.replace(/^#/,"")||"/");
  const acc=useAccessibility();
  useEffect(()=>{ const onHash=()=>setRoute(location.hash.replace(/^#/,"")||"/"); window.addEventListener("hashchange",onHash); return ()=>window.removeEventListener("hashchange",onHash);},[]);
  useEffect(()=>{ document.body.style.fontFamily = acc.font==="OpenDyslexic" ? "OpenDyslexicLocal, Arial, sans-serif" : (acc.font==="Verdana" ? "Verdana, Geneva, Tahoma, sans-serif" : "Arial, Helvetica, sans-serif"); },[acc.font]);

  if(route==="/defi") return <GameDefi acc={acc}/>;
  if(route==="/pythagore") return <GamePythagore acc={acc}/>;
  if(route==="/inverse") return <GameInverse acc={acc}/>;
  return <div className="min-h-screen p-6"><TopNav route="/" go={k=>location.hash="#"+k}/><Hub/></div>;
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
