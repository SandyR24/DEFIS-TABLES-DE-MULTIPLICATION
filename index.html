<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-store"/>
<title>Sacado Acad√©mie ‚Äî Automatismes</title>

<!-- React + ReactDOM -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{ --brand:#8374a7; }
  body{ margin:0; background:#f8fafc; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .hero{ background:#efe7ff; }
  .card{ background:#fff; border:1px solid #e5e7eb; }
  .btn{ background:var(--brand); color:#fff; }
  .pill{ padding:.45rem .8rem; border:1px solid #e5e7eb; border-radius:999px; background:#fff; cursor:pointer; color:#111827; }
  .pill.active{ background:var(--brand); border-color:var(--brand); color:#fff; }
  .hdr{ background:#f1f5f9; }
  .ok{ background:#dcfce7; } .ko{ background:#fee2e2; }
  .ko-input{ color:#be185d !important; font-weight:700; } /* chiffre erron√© en rose fonc√© */

  /* Diagonale (fond + texte violets) */
  .diag-bg  { background: rgba(131,116,167,.16) !important; }
  .diag-txt { color:#8374a7 !important; font-weight:700; }

  /* Indice ‚Äú√† remplir‚Äù (violet l√©ger) */
  .fill-hint { background: rgba(131,116,167,.12) !important; }

  /* √âcran noir global */
  .dark-mode, .dark-mode * { color:#f8fafc !important; }
  .dark-mode .card{ background:#111111 !important; border-color:#334155 !important; }
  .dark-mode .hdr{ background:#1f2937 !important; }
  .dark-mode input, .dark-mode select{ background:#000 !important; color:#f8fafc !important; border-color:#64748b !important; }
  .dark-mode .pill{ background:#fff !important; color:#111827 !important; border-color:#e5e7eb !important; }

  /* ---- OpenDyslexic local ----
     IMPORTANT : v√©rifie que ces noms de fichiers existent bien √† la racine du repo.
     Mets au minimum OpenDyslexic-Regular.otf ; l'Alta est optionnelle. */
  @font-face{
    font-family:'OpenDyslexicLocal';
    src:
      url('OpenDyslexic-Regular.otf') format('opentype'),
      url('OpenDyslexicAlta-Regular.otf') format('opentype');
    font-display:swap;
  }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="env,react">
const {useState,useEffect,useMemo,useRef} = React;
const BRAND = "#8374a7";
const range=(a,b)=>Array.from({length:b-a+1},(_,i)=>a+i);

/* --------------------- UI commun --------------------- */
function TopNav({route,go}){
  return (
    <div className="mb-6 rounded-3xl overflow-hidden shadow-sm border card">
      <div className="px-4 py-3 text-white flex items-center justify-between" style={{backgroundColor:BRAND}}>
        <div className="flex items-center gap-3">
          <img src="sacadoLogo.png" className="h-8 w-8 rounded-lg bg-white/90 p-1" alt="SACADO"/>
          <div>
            <div className="font-black leading-tight">Sacado Acad√©mie</div>
            <div className="text-xs opacity-90">Automatismes</div>
          </div>
        </div>
        <img src="dogbot.png" className="h-8 w-8 rounded-full bg-white/90 p-0.5" alt="DogBot"/>
      </div>
      <div className="px-4 py-3 flex flex-wrap gap-2 bg-white/60">
        {[
          {k:"/", label:"Accueil"},
          {k:"/defi", label:"Jeu n¬∞1 ‚Äì D√©fi Tables"},
          {k:"/pythagore", label:"Jeu n¬∞2 ‚Äì Table de Pythagore"},
          {k:"/inverse", label:"Jeu n¬∞3 ‚Äì Retrouve la multiplication"},
        ].map(tab=>(
          <button key={tab.k} onClick={()=>go(tab.k)} className={"pill "+(route===tab.k?"active":"")}>{tab.label}</button>
        ))}
      </div>
    </div>
  );
}
function Hero(){
  return (
    <header className="hero p-6 md:p-10 text-center rounded-3xl card">
      <h1 className="text-3xl md:text-5xl font-extrabold text-[var(--brand)]">Sacado Acad√©mie - Atelier Automatismes</h1>
      <p className="mt-2 text-slate-700">Entra√Æne-toi sur les tables de multiplication avec DogBot üêæ</p>
      <img src="dogbot.png" className="mx-auto mt-4 h-28 w-28 rounded-full bg-white p-1 shadow" alt="DogBot"/>
    </header>
  );
}
function Hub(){
  return (
    <main className="max-w-5xl mx-auto px-4 py-8">
      <Hero/>
      <h2 className="text-center text-2xl md:text-3xl font-extrabold text-[var(--brand)] my-6">Choisis ton activit√©</h2>
      <div className="grid md:grid-cols-3 gap-6">
        <article className="card rounded-3xl p-6"><h3 className="text-xl font-extrabold text-[var(--brand)]">Jeu n¬∞1 ‚Äî D√©fi Tables</h3><a href="#/defi" className="inline-block mt-4 px-4 py-2 rounded-2xl btn">Commencer</a></article>
        <article className="card rounded-3xl p-6"><h3 className="text-xl font-extrabold text-[var(--brand)]">Jeu n¬∞2 ‚Äî Table de Pythagore</h3><a href="#/pythagore" className="inline-block mt-4 px-4 py-2 rounded-2xl btn">D√©couvrir</a></article>
        <article className="card rounded-3xl p-6"><h3 className="text-xl font-extrabold text-[var(--brand)]">Jeu n¬∞3 ‚Äî Retrouve la multiplication</h3><a href="#/inverse" className="inline-block mt-4 px-4 py-2 rounded-2xl btn">Jouer</a></article>
      </div>
    </main>
  );
}

/* --------------------- Accessibilit√© partag√©e --------------------- */
function useAccessibility(){
  const [font,setFont]=useState("Arial");
  const [size,setSize]=useState(16);
  const [yellow,setYellow]=useState(false);
  const [black,setBlack]=useState(false);
  const [audio,setAudio]=useState(false);
  useEffect(()=>{ document.body.style.fontSize = `${size}px`; },[size]);

  const rootBg  = black ? "#000000" : (yellow ? "#fff7cc" : "#f8fafc");
  const surface = black ? "#111111" : (yellow ? "#fff2a8" : "#ffffff");
  const rootText= black ? "#f8fafc" : undefined;
  const cardStyle = { backgroundColor: surface, color: rootText };
  const fontFamily =
    font==="Verdana" ? "Verdana, Geneva, Tahoma, sans-serif" :
    font==="OpenDyslexic" ? "OpenDyslexicLocal, Arial, sans-serif" :
    "Arial, Helvetica, sans-serif";

  const speak=(txt)=>{ try{ if(!audio) return; const u=new SpeechSynthesisUtterance(txt); u.lang="fr-FR"; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} };

  return {font,setFont,size,setSize,yellow,setYellow,black,setBlack,audio,setAudio,rootBg,cardStyle,rootText,fontFamily,speak};
}
function AccessibilityCard({acc}){
  return (
    <div className="card rounded-2xl p-4" style={acc.cardStyle}>
      <div className="font-bold mb-2">Accessibilit√©</div>
      <div className="flex gap-2 flex-wrap mb-2">
        <select value={acc.font} onChange={e=>acc.setFont(e.target.value)} className="border rounded p-1">
          <option>Arial</option><option>Verdana</option><option>OpenDyslexic</option>
        </select>
        <select value={acc.size} onChange={e=>acc.setSize(parseInt(e.target.value))} className="border rounded p-1">
          {[16,18,20,22,24].map(s=><option key={s} value={s}>{s}px</option>)}
        </select>
      </div>
      <label className="block"><input type="checkbox" checked={acc.yellow} onChange={e=>acc.setYellow(e.target.checked)}/> Fond jaune</label>
      <label className="block"><input type="checkbox" checked={acc.black} onChange={e=>acc.setBlack(e.target.checked)}/> √âcran noir</label>
      <div className="mt-2 flex items-center gap-2"><input type="checkbox" checked={acc.audio} onChange={e=>acc.setAudio(e.target.checked)}/><label>Audio (TTS)</label></div>
    </div>
  );
}

/* --------------------- Jeu n¬∞1 ‚Äî D√©fi Tables --------------------- */
function GameDefi({acc}){
  const {rootBg,rootText,cardStyle,fontFamily,speak,black}=acc;
  const [selectedTables,setSelectedTables]=useState(range(2,10));
  const [questionCount,setQuestionCount]=useState(10);
  const [timeLimit,setTimeLimit]=useState(5); // null = Pas de chrono
  const [started,setStarted]=useState(false), [finished,setFinished]=useState(false);
  const [questions,setQuestions]=useState([]), [index,setIndex]=useState(0);
  const [input,setInput]=useState(""), [tick,setTick]=useState(0), [answers,setAnswers]=useState([]);
  const inputRef=useRef(null);

  useEffect(()=>{ if(!started||finished) return; const id=setInterval(()=>setTick(t=>t+1),1000); return ()=>clearInterval(id);},[started,finished]);
  useEffect(()=>{ if(!started||finished) return; if(timeLimit!=null && tick>=timeLimit) handleSubmit(true); },[tick]);
  useEffect(()=>{ if(started && !finished && questions[index]){ const q=questions[index]; speak(`${q.a} multipli√© par ${q.b}`);} },[index,started,finished]);

  const start=()=>{
    const list=[]; for(let i=0;i<questionCount;i++){ const a=selectedTables[Math.floor(Math.random()*selectedTables.length)], b=Math.floor(Math.random()*9)+2; list.push({a,b,product:a*b});}
    setQuestions(list); setIndex(0); setAnswers([]); setInput(""); setTick(0); setStarted(true); setFinished(false);
    setTimeout(()=>inputRef.current?.focus(),0); speak("Pr√©pare-toi. Premi√®re question.");
  };
  const current=questions[index];
  const progressPct = useMemo(()=>{ if(!started) return 0; if(timeLimit==null) return 100; const total=timeLimit, remaining=Math.max(0,total-tick); return (remaining/total)*100; },[started,tick,timeLimit]);

  const handleSubmit=(timeout=false)=>{
    if(!current) return;
    const userNum=Number(input), userProvided=input!=="", correct=!timeout && userNum===current.product && userProvided;
    const record={a:current.a,b:current.b,product:current.product,user:timeout?null:(userProvided?userNum:null),correct,time:timeLimit!=null?Math.min(tick,timeLimit):tick,timeout};
    setAnswers(p=>[...p,record]);
    if(index+1>=questions.length){ setFinished(true); setStarted(false); } else { setIndex(i=>i+1); setTick(0); setInput(""); }
  };
  const score=useMemo(()=>answers.filter(a=>a.correct).length,[answers]);

  return (
    <div className={(acc.black?"dark-mode ":"")+"min-h-screen p-6"} style={{backgroundColor:rootBg,color:rootText,fontFamily}}>
      <TopNav route="/defi" go={k=>location.hash="#"+k}/>
      <div className="max-w-4xl mx-auto space-y-6">
        {!started && !finished && (
          <div className="grid md:grid-cols-3 gap-4">
            <AccessibilityCard acc={acc}/>
            <div className="card rounded-2xl p-4" style={cardStyle}>
              <div className="font-bold mb-2">R√©glages</div>
              <div className="mb-2"><div className="text-sm mb-1">Tables</div>
                <div className="flex flex-wrap gap-2">{range(2,10).map(n=><button key={n} onClick={()=>setSelectedTables(p=>p.includes(n)?p.filter(x=>x!==n):[...p,n])} className={"pill "+(selectedTables.includes(n)?"active":"")}>{n}</button>)}</div>
              </div>
              <div className="mb-2"><div className="text-sm mb-1">Nombre de questions</div>
                <div className="flex gap-2 flex-wrap">{[5,10,15,20].map(n=><button key={n} onClick={()=>setQuestionCount(n)} className={"pill "+(questionCount===n?"active":"")}>{n}</button>)}</div>
              </div>
              <div><div className="text-sm mb-1">Temps par question</div>
                <div className="flex gap-2 flex-wrap">{[3,5,10].map(s=><button key={s} onClick={()=>setTimeLimit(s)} className={"pill "+(timeLimit===s?"active":"")}>{s}s</button>)}
                  <button onClick={()=>setTimeLimit(null)} className={"pill "+(timeLimit==null?"active":"")}>Pas de chrono</button></div>
              </div>
            </div>
            <div className="card rounded-2xl p-4" style={cardStyle}><div className="font-bold mb-2">Action</div><button onClick={start} className="px-4 py-2 rounded-2xl text-white" style={{backgroundColor:BRAND}}>Lancer le d√©fi</button></div>
          </div>
        )}

        {started && current && (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>Question {index+1}/{questions.length}</div>
              {timeLimit!=null && <div className="w-52"><div className="w-full h-3 rounded-full bg-slate-200 overflow-hidden"><div className="h-full transition-all" style={{width:`${Math.max(0,Math.min(100,(Math.max(0,timeLimit-tick)/timeLimit)*100))}%`,backgroundColor:BRAND}}/></div></div>}
            </div>
            <div className="rounded-3xl border p-6 text-center shadow-sm card" style={cardStyle}>
              <div className="font-black text-5xl mb-4">{current.a} √ó {current.b} = ?</div>
              <div className="flex gap-3 justify-center">
                <input ref={inputRef} value={input} onChange={e=>setInput(e.target.value.replace(/\D/g,""))} onKeyDown={e=>{ if(e.key==='Enter') handleSubmit(false); }} className="w-40 text-center text-3xl px-4 py-3 rounded-2xl border" style={{borderColor:BRAND, backgroundColor:black?'#000':'#fff', color:acc.rootText}} placeholder="R√©ponse"/>
                <button onClick={()=>handleSubmit(false)} className="px-5 py-3 rounded-2xl text-white font-semibold shadow" style={{backgroundColor:BRAND}}>Valider</button>
              </div>
            </div>
          </div>
        )}

        {finished && (
          <div className="space-y-6">
            <div className="rounded-3xl border p-6 shadow-sm card" style={cardStyle}><h2 className="text-2xl font-black">R√©capitulatif</h2><p>Score : {score} / {answers.length} ({Math.round((score/answers.length)*100)}%)</p></div>
            <div className="rounded-3xl border p-4 shadow-sm overflow-x-auto card" style={cardStyle}>
              <table className="w-full text-left text-sm"><thead><tr><th>#</th><th>√ânonc√©</th><th>R√©ponse</th><th>Correction</th><th>Statut</th></tr></thead>
                <tbody>{answers.map((r,i)=>(<tr key={i} className="border-t"><td>{i+1}</td><td>{r.a}√ó{r.b}</td><td>{r.user ?? "‚Äî"}</td><td>{r.product}</td><td>{r.timeout?"‚è± Hors d√©lai":(r.user==null?"‚Äî Pas de r√©ponse":(r.correct?"‚úî Juste":"‚úò Faux"))}</td></tr>))}</tbody>
              </table>
            </div>
            <div className="flex gap-2"><a className="px-5 py-3 rounded-2xl border" href="#/defi">Retour aux r√©glages</a><a className="px-5 py-3 rounded-2xl border" href="#/">Retour au menu</a></div>
          </div>
        )}
      </div>
    </div>
  );
}

/* --------------------- Jeu n¬∞2 ‚Äî Table de Pythagore (derni√®re version) --------------------- */
function GamePythagore({acc}){
  const {rootBg,rootText,cardStyle,fontFamily,speak}=acc;
  const A=range(2,10), B=range(2,10);

  // Modes: random | table | diagonal | mirror | minimal
  const [mode,setMode]=useState("random");
  const [count,setCount]=useState(10);
  const [table,setTable]=useState(6);

  const key=(a,b)=>`${a}x${b}`;
  const mirrorKey=(a,b)=>`${b}x${a}`;

  // Cases √† compl√©ter selon le mode
  const blanks = useMemo(()=>{
    const set=new Set();
    if(mode==="random"){
      const all=[]; for(const a of A)for(const b of B) all.push(key(a,b));
      while(set.size<Math.min(count,all.length)) set.add(all[Math.floor(Math.random()*all.length)]);
    }else if(mode==="table"){
      B.forEach(b=> set.add(key(table,b)));
    }else if(mode==="diagonal"){
      A.forEach(a=> set.add(key(a,a)));
    }else if(mode==="mirror"){
      // Triangle sup√©rieur (sauf diagonale qui sera pr√©remplie)
      for(const a of A) for(const b of B) if(a<=b && a!==b) set.add(key(a,b));
    }else if(mode==="minimal"){
      // 6 cases restantes : 6√ó7,6√ó8,6√ó9,7√ó8,7√ó9,8√ó9
      for(let a=6;a<=9;a++) for(let b=a+1;b<=9;b++) set.add(key(a,b));
    }
    return set;
  },[mode,count,table]);

  const [values,setValues]=useState({});
  const [checked,setChecked]=useState({});

  const onChange=(k,v)=> setValues(p=>({...p,[k]:v.replace(/\D/g,"")}));
  const getDisplayValue=(a,b)=>{
    const k=key(a,b), m=mirrorKey(a,b);
    return values[k] ?? (mode==="mirror" ? values[m] : "") ?? "";
  };

  const checkAll=()=>{
    const res={};
    for(const a of A)for(const b of B){
      const k=key(a,b), onDiag=(a===b);
      const shouldCheck =
        blanks.has(k) ||
        (mode==="mirror" && a>b && blanks.has(mirrorKey(a,b))) ||
        (mode==="diagonal" && onDiag);
      if(!shouldCheck) continue;
      const good=a*b;
      const vStr = values[k] ?? (mode==="mirror" ? values[mirrorKey(a,b)] : "");
      res[k] = vStr!==undefined && vStr!=="" && Number(vStr)===good ? "ok":"ko";
    }
    setChecked(res);
  };

  const tip =
    mode==="random"   ? "Consigne : compl√®te les cases violettes (au hasard)."
  : mode==="table"    ? `Consigne : compl√®te les cases violettes de la table de ${table}.`
  : mode==="diagonal" ? "Consigne : compl√®te uniquement la diagonale (les doubles). Tes r√©ponses s‚Äôaffichent en violet."
  : mode==="mirror"   ? "Consigne : compl√®te le triangle sup√©rieur ; l‚Äôautre moiti√© est identique (a√ób = b√óa)."
  : /* minimal */       "Consigne : compl√®te seulement les 6 cases restantes (6√ó7, 6√ó8, 6√ó9, 7√ó8, 7√ó9, 8√ó9).";

  const help =
    mode==="mirror"
      ? "Gr√¢ce √† la commutativit√© (a√ób = b√óa), conna√Ætre la moiti√© de la table suffit. La diagonale violette montre les doubles."
      : mode==="minimal"
      ? "Si tu connais tes tables jusqu‚Äô√† 5, la table de 10 et les doubles (diagonale violette), il ne reste que 6 r√©sultats √† apprendre : 6√ó7, 6√ó8, 6√ó9, 7√ó8, 7√ó9, 8√ó9."
      : null;

  return (
    <div className="min-h-screen p-6" style={{backgroundColor:rootBg,color:rootText,fontFamily}}>
      <TopNav route="/pythagore" go={k=>location.hash="#"+k}/>
      <div className="max-w-6xl mx-auto">
        {/* Barre du haut */}
        <div className="grid xl:grid-cols-3 gap-4 mb-4">
          <AccessibilityCard acc={acc}/>
          <div className="card rounded-2xl p-4" style={cardStyle}>
            <div className="font-bold mb-2">Mode</div>
            <div className="grid gap-2">
              <label><input type="radio" name="m" checked={mode==="random"} onChange={()=>setMode("random")}/> Al√©atoires</label>
              {mode==="random" && (
                <div className="ml-6">
                  <label className="text-sm">Nombre de cases</label>
                  <input type="number" min="1" max="81" value={count}
                    onChange={e=>setCount(parseInt(e.target.value)||1)}
                    className="border rounded px-2 py-1 w-24 ml-2"/>
                </div>
              )}
              <label><input type="radio" name="m" checked={mode==="table"} onChange={()=>setMode("table")}/> Table par table</label>
              {mode==="table" && (
                <div className="ml-6">
                  <label className="text-sm">Table</label>
                  <select value={table} onChange={e=>setTable(parseInt(e.target.value))} className="border rounded px-2 py-1 ml-2">
                    {A.map(t=><option key={t} value={t}>{t}</option>)}
                  </select>
                </div>
              )}
              <label><input type="radio" name="m" checked={mode==="diagonal"} onChange={()=>setMode("diagonal")}/> Diagonale des doubles</label>
              <label><input type="radio" name="m" checked={mode==="mirror"} onChange={()=>setMode("mirror")}/> Miroir de la diagonale (commutativit√©)</label>
              <label><input type="radio" name="m" checked={mode==="minimal"} onChange={()=>setMode("minimal")}/> Reste √† apprendre (6‚Äì9)</label>
            </div>
          </div>
          <div className="card rounded-2xl p-4" style={cardStyle}>
            <div className="font-bold mb-2">Actions</div>
            <button onClick={checkAll} className="px-4 py-2 rounded-2xl text-white mr-2" style={{backgroundColor:"#8374a7"}}>Corriger</button>
          </div>
        </div>

        {/* Consigne */}
        <div className="card rounded-2xl p-3 mb-4" style={cardStyle}>
          <strong>Consigne :</strong> <span className="diag-txt">{tip.replace(/^Consigne :\s*/,'')}</span>
        </div>

        {/* Table */}
        <div className="overflow-auto">
          <table className="min-w-[900px] border-collapse">
            <thead>
              <tr>
                <th className="p-2 hdr text-left">√ó</th>
                {B.map(b=><th key={b} className="p-2 hdr">{b}</th>)}
              </tr>
            </thead>
            <tbody>
              {A.map(a=>(
                <tr key={a}>
                  <th className="p-2 hdr text-left">{a}</th>
                  {B.map(b=>{
                    const k=key(a,b), onDiag=(a===b);

                    // quelles cases doivent √™tre remplies ?
                    const shouldFill =
                      (mode==="mirror"   ? (a<=b && !onDiag) :
                       mode==="minimal"  ? (a>=6 && b>=6 && a<b) :
                       mode==="diagonal" ? onDiag :
                       mode==="table"    ? (a===table) :
                       /* random */         blanks.has(k));

                    const needsHint = shouldFill && !((mode==="mirror"||mode==="minimal") && onDiag);
                    const st = checked[k] || (mode==="mirror" ? checked[mirrorKey(a,b)] : undefined);
                    const koClass = st==="ko" ? "ko-input" : "";

                    // Diagonale pr√©-remplie (Mirror & Minimal)
                    if((mode==="mirror"||mode==="minimal") && onDiag){
                      return (
                        <td key={k} className="p-1 text-center diag-bg">
                          <span className="inline-block min-w-[84px] text-lg diag-txt">{a*b}</span>
                        </td>
                      );
                    }
                    // Triangle inf√©rieur lecture seule (Mirror)
                    if(mode==="mirror" && a>b){
                      const val = getDisplayValue(a,b);
                      return (
                        <td key={k} className="p-1 text-center diag-bg">
                          <input readOnly value={val} className={"border rounded px-2 py-2 w-[84px] text-center text-lg diag-txt "+koClass}/>
                        </td>
                      );
                    }
                    // Diagonale √† saisir (mode diagonal) ‚Äî saisie violette
                    if(mode==="diagonal" && onDiag){
                      return (
                        <td key={k} className="p-1 text-center">
                          <input value={getDisplayValue(a,b)} onChange={e=>onChange(k,e.target.value)}
                            className={"border rounded px-2 py-2 w-[84px] text-center text-lg diag-txt "+koClass}/>
                        </td>
                      );
                    }
                    // Cellule standard
                    return (
                      <td key={k} className={"p-1 text-center "+(needsHint?"fill-hint ":"")+(st==="ok"?" ok":st==="ko"?" ko":"")}>
                        {shouldFill ? (
                          <input value={getDisplayValue(a,b)} onChange={e=>onChange(k,e.target.value)}
                            className={"border rounded px-2 py-2 w-[84px] text-center text-lg "+koClass}/>
                        ) : (
                          <span className={"inline-block min-w-[84px] text-lg "+(onDiag?"diag-txt":"")}>{a*b}</span>
                        )}
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {help && (
          <div className="mt-4 card rounded-2xl p-4" style={cardStyle}>
            <strong>Astuce p√©dagogique ‚Äî </strong>
            <span className="diag-txt">{help}</span>
          </div>
        )}

        <div className="mt-6"><a href="#/" className="px-4 py-2 rounded-2xl border">Retour au menu</a></div>
      </div>
    </div>
  );
}

/* --------------------- Jeu n¬∞3 ‚Äî Retrouve la multiplication (2 modes) --------------------- */
function GameInverse({acc}){
  const {rootBg,rootText,cardStyle,fontFamily,speak,black}=acc;

  // R√©glages communs
  const [questionCount,setQuestionCount]=useState(10);
  const [timeLimit,setTimeLimit]=useState(5); // null = Pas de chrono
  const [mode,setMode]=useState("single");    // "single" | "all"

  // √âtat du run
  const [started,setStarted]=useState(false), [finished,setFinished]=useState(false);
  const [questions,setQuestions]=useState([]), [index,setIndex]=useState(0);
  const [tick,setTick]=useState(0), [answers,setAnswers]=useState([]);

  // Mode single
  const [aInput,setAInput]=useState(""), [bInput,setBInput]=useState("");
  const aRef=useRef(null);

  // Mode all
  const pairsFor=(n)=>{ const out=[]; for(let a=2;a<=10;a++){ const b=n/a; if(Number.isInteger(b)&&b>=2&&b<=10) out.push([a,b]); } return out; };
  const current = questions[index];
  const [allRows,setAllRows]=useState([]); // [{a:"",b:""}, ...]

  // ticker
  useEffect(()=>{ if(!started||finished) return; const id=setInterval(()=>setTick(t=>t+1),1000); return ()=>clearInterval(id);},[started,finished]);
  useEffect(()=>{ if(!started||finished) return; if(timeLimit!=null && tick>=timeLimit) handleSubmit(true); },[tick]);

  const newProduct=()=>{ const a=2+Math.floor(Math.random()*9), b=2+Math.floor(Math.random()*9); return a*b; };

  const start=()=>{
    const list=[]; for(let i=0;i<questionCount;i++) list.push({product:newProduct()});
    setQuestions(list); setIndex(0); setAnswers([]); setTick(0);
    setStarted(true); setFinished(false);
    const p=list[0].product;
    if(mode==="single"){ setAInput(""); setBInput(""); setTimeout(()=>aRef.current?.focus(),0); }
    else{ setAllRows(pairsFor(p).map(()=>({a:"",b:""}))); }
    speak(mode==="single" ? "Trouve une d√©composition du produit." : "Donne toutes les d√©compositions du produit.");
  };

  useEffect(()=>{
    if(!started || !current) return;
    if(mode==="single"){ setAInput(""); setBInput(""); setTimeout(()=>aRef.current?.focus(),0); }
    else{ setAllRows(pairsFor(current.product).map(()=>({a:"",b:""}))); }
    speak(`Quel produit donne ${current.product}`);
  },[started,index,mode]);

  const progressPct = useMemo(()=>{
    if(!started) return 0; if(timeLimit==null) return 100;
    const total=timeLimit, remaining=Math.max(0,total-tick);
    return (remaining/total)*100;
  },[started,tick,timeLimit]);

  const handleSubmit=(timeout=false)=>{
    if(!current) return;

    if(mode==="single"){
      const a = parseInt(aInput,10), b = parseInt(bInput,10);
      const provided = Number.isInteger(a) && Number.isInteger(b);
      const ok = !timeout && provided && a>=2&&a<=10&&b>=2&&b<=10 && (a*b===current.product);
      const rec = {mode, product:current.product, a:provided?a:null, b:provided?b:null, correct:ok, timeout};
      setAnswers(p=>[...p,rec]);
    }else{
      const target = pairsFor(current.product);
      const targetKeys = target.map(([x,y])=>`${x}x${y}`);
      const targetMap = new Map(); targetKeys.forEach(k=>targetMap.set(k,(targetMap.get(k)||0)+1));

      const rows = allRows.map(({a,b})=>[parseInt(a,10),parseInt(b,10)]);
      const providedAll = rows.every(([a,b])=>Number.isInteger(a)&&Number.isInteger(b));
      let used = new Map(), exact=true;

      for(const [a,b] of rows){
        const k=`${a}x${b}`, valid = Number.isInteger(a)&&Number.isInteger(b)&&a>=2&&a<=10&&b>=2&&b<=10&&(a*b===current.product);
        if(!valid){ exact=false; continue; }
        used.set(k,(used.get(k)||0)+1);
      }
      for(const [k,c] of targetMap){ if(used.get(k)!==c){ exact=false; break; } }
      for(const [k,c] of used){ if(targetMap.get(k)!==c){ exact=false; break; } }

      const ok = !timeout && providedAll && exact;
      const rec = {mode, product:current.product, rows:allRows, correct:ok, timeout, expected:target};
      setAnswers(p=>[...p,rec]);
    }

    if(index+1>=questions.length){ setFinished(true); setStarted(false); }
    else { setIndex(i=>i+1); setTick(0); }
  };

  const score=useMemo(()=>answers.filter(a=>a.correct).length,[answers]);

  return (
    <div className={(acc.black?"dark-mode ":"")+"min-h-screen p-6"} style={{backgroundColor:rootBg,color:rootText,fontFamily}}>
      <TopNav route="/inverse" go={k=>location.hash="#"+k}/>
      <div className="max-w-4xl mx-auto space-y-6">

        {!started && !finished && (
          <div className="grid md:grid-cols-3 gap-4">
            <AccessibilityCard acc={acc}/>

            <div className="card rounded-2xl p-4" style={cardStyle}>
              <div className="font-bold mb-2">Mode</div>
              <div className="flex flex-col gap-2">
                <label><input type="radio" name="m3" checked={mode==="single"} onChange={()=>setMode("single")}/> Une d√©composition</label>
                <label><input type="radio" name="m3" checked={mode==="all"}    onChange={()=>setMode("all")}   /> Toutes les d√©compositions</label>
              </div>

              <div className="font-bold mt-4 mb-1">Nombre de questions</div>
              <div className="flex gap-2 flex-wrap">{[5,10,15,20].map(n=>
                <button key={n} onClick={()=>setQuestionCount(n)} className={"pill "+(questionCount===n?"active":"")}>{n}</button>
              )}</div>

              <div className="font-bold mt-4 mb-1">Temps par question</div>
              <div className="flex gap-2 flex-wrap">
                {[3,5,10].map(s=><button key={s} onClick={()=>setTimeLimit(s)} className={"pill "+(timeLimit===s?"active":"")}>{s}s</button>)}
                <button onClick={()=>setTimeLimit(null)} className={"pill "+(timeLimit==null?"active":"")}>Pas de chrono</button>
              </div>
            </div>

            <div className="card rounded-2xl p-4" style={cardStyle}>
              <div className="font-bold mb-2">Action</div>
              <button onClick={start} className="px-4 py-2 rounded-2xl text-white" style={{backgroundColor:BRAND}}>Commencer</button>
            </div>
          </div>
        )}

        {started && current && (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>Question {index+1}/{questions.length} ‚Äî {mode==="single" ? "Une d√©composition" : "Toutes les d√©compositions"}</div>
              {timeLimit!=null && (
                <div className="w-52">
                  <div className="w-full h-3 rounded-full bg-slate-200 overflow-hidden">
                    <div className="h-full transition-all" style={{width:`${Math.max(0,Math.min(100,(Math.max(0,timeLimit-tick)/timeLimit)*100))}%`, backgroundColor:BRAND}}/>
                  </div>
                </div>
              )}
            </div>

            <div className="rounded-3xl border p-6 text-center shadow-sm card" style={cardStyle}>
              <div className="text-slate-500">R√©sultat</div>
              <div className="font-black text-5xl mb-4">{current.product}</div>

              {mode==="single" ? (
                <div className="flex gap-3 justify-center items-center">
                  <input ref={aRef} value={aInput} onChange={e=>setAInput(e.target.value.replace(/\D/g,""))}
                         onKeyDown={e=>{ if(e.key==='Enter') handleSubmit(false); }}
                         className="w-24 text-center text-3xl px-4 py-3 rounded-2xl border" placeholder="a"/>
                  <span className="text-3xl">√ó</span>
                  <input value={bInput} onChange={e=>setBInput(e.target.value.replace(/\D/g,""))}
                         onKeyDown={e=>{ if(e.key==='Enter') handleSubmit(false); }}
                         className="w-24 text-center text-3xl px-4 py-3 rounded-2xl border" placeholder="b"/>
                  <button onClick={()=>handleSubmit(false)} className="px-5 py-3 rounded-2xl text-white font-semibold shadow" style={{backgroundColor:BRAND}}>Valider</button>
                </div>
              ) : (
                <div className="space-y-2 max-w-md mx-auto">
                  {pairsFor(current.product).map((_,i)=>(
                    <div key={i} className="flex items-center gap-2 justify-center">
                      <input value={allRows[i]?.a||""} onChange={e=>setAllRows(r=>{const n=[...r]; n[i]={...n[i],a:e.target.value.replace(/\D/g,"")}; return n;})}
                             className="w-20 text-center text-2xl px-3 py-2 rounded-2xl border" placeholder="a"/>
                      <span className="text-2xl">√ó</span>
                      <input value={allRows[i]?.b||""} onChange={e=>setAllRows(r=>{const n=[...r]; n[i]={...n[i],b:e.target.value.replace(/\D/g,"")}; return n;})}
                             className="w-20 text-center text-2xl px-3 py-2 rounded-2xl border" placeholder="b"/>
                    </div>
                  ))}
                  <div className="pt-2">
                    <button onClick={()=>handleSubmit(false)} className="px-5 py-3 rounded-2xl text-white font-semibold shadow" style={{backgroundColor:BRAND}}>Valider</button>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {finished && (
          <div className="space-y-6">
            <div className="rounded-3xl border p-6 shadow-sm card" style={cardStyle}>
              <h2 className="text-2xl font-black">R√©capitulatif</h2>
              <p>Score : {score} / {answers.length} ({Math.round((score/answers.length)*100)}%)</p>
            </div>

            <div className="rounded-3xl border p-4 shadow-sm overflow-x-auto card" style={cardStyle}>
              <table className="w-full text-left text-sm">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>R√©sultat</th>
                    <th>R√©ponse(s)</th>
                    <th>Correction attendue</th>
                    <th>Statut</th>
                  </tr>
                </thead>
                <tbody>
                  {answers.map((r,i)=>(
                    <tr key={i} className="border-t">
                      <td>{i+1}</td>
                      <td>{r.product}</td>
                      <td>
                        {r.mode==="single"
                          ? (r.a!=null && r.b!=null ? `${r.a}√ó${r.b}` : "‚Äî")
                          : (r.rows || []).map((x,j)=> (x.a && x.b) ? `${x.a}√ó${x.b}` : "‚Äî").join(" ; ")
                        }
                      </td>
                      <td>
                        {r.mode==="single"
                          ? r.product
                          : (pairsFor(r.product) || []).map(([a,b])=>`${a}√ó${b}`).join(" ; ")
                        }
                      </td>
                      <td>{r.timeout ? "‚è± Hors d√©lai" :
                            (r.mode==="single"
                              ? (r.a==null||r.b==null ? "‚Äî Pas de r√©ponse" : (r.correct ? "‚úî Juste" : "‚úò Faux"))
                              : ((r.rows||[]).some(x=>!x.a||!x.b) ? "‚Äî Pas de r√©ponse" : (r.correct ? "‚úî Juste" : "‚úò Faux"))
                          )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="flex gap-2">
              <a className="px-5 py-3 rounded-2xl border" href="#/inverse">Retour aux r√©glages</a>
              <a className="px-5 py-3 rounded-2xl border" href="#/">Retour au menu</a>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* --------------------- App / Router --------------------- */
function App(){
  const [route,setRoute]=useState(location.hash.replace(/^#/,"")||"/");
  const acc=useAccessibility();
  useEffect(()=>{ const onHash=()=>setRoute(location.hash.replace(/^#/,"")||"/"); window.addEventListener("hashchange",onHash); return ()=>window.removeEventListener("hashchange",onHash);},[]);
  // applique police globale
  useEffect(()=>{ document.body.style.fontFamily = acc.font==="OpenDyslexic" ? "OpenDyslexicLocal, Arial, sans-serif" : (acc.font==="Verdana" ? "Verdana, Geneva, Tahoma, sans-serif" : "Arial, Helvetica, sans-serif"); },[acc.font]);

  if(route==="/defi") return <GameDefi acc={acc}/>;
  if(route==="/pythagore") return <GamePythagore acc={acc}/>;
  if(route==="/inverse") return <GameInverse acc={acc}/>;
  return <div className="min-h-screen p-6"><TopNav route="/" go={k=>location.hash="#"+k}/><Hub/></div>;
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
